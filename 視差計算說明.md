# 蝦子視差計算詳細說明

## 1. 視差（Disparity）的基本概念

### 什麼是視差？
視差是立體視覺中的核心概念，指的是同一個物體在左右兩個攝影機中的水平位置差異。

```
視差 = 左影像中的x座標 - 右影像中的x座標
disparity = x_left - x_right
```

### 視差的物理意義
- **正視差**：物體在左影像中比右影像中更靠右（物體較近）
- **負視差**：物體在左影像中比右影像中更靠左（物體較遠）
- **零視差**：物體在左右影像中位置相同（物體在無限遠）

## 2. 視差與深度的關係

視差與物體深度成反比關係：

```
深度 = (焦距 × 基線距離) / 視差
depth = (focal_length × baseline) / disparity
```

其中：
- `focal_length`：攝影機焦距（像素為單位）
- `baseline`：左右攝影機之間的距離（實際物理距離）
- `disparity`：視差值（像素為單位）

## 3. 當前程式的視差計算流程

### 步驟1：物體匹配
使用NCC（Normalized Cross-Correlation）演算法找到左右影像中對應的蝦子。

### 步驟2：曲線擬合
對每隻蝦子的遮罩點擬合最佳迴歸曲線：
- 線性曲線：`y = ax + b`
- 二次曲線：`y = ax² + bx + c`
- 三次曲線：`y = ax³ + bx² + cx + d`

### 步驟3：對應點採樣
在左右蝦子的曲線上採樣N個對應點。

**關鍵問題：如何確保左右點是對應的？**

#### 方法1：基於相同x座標採樣（原方法）
```python
# 在左蝦子的x範圍內採樣
left_x = np.linspace(left_x_min, left_x_max, n_points)
left_y = 根據曲線方程計算

# 在右蝦子的x範圍內採樣
right_x = np.linspace(right_x_min, right_x_max, n_points)
right_y = 根據曲線方程計算
```

**問題**：這種方法假設左右蝦子在相同的x位置，但實際上立體圖像對中物體會有位移。

#### 方法2：基於相對位置採樣（改進方法）
```python
# 使用歸一化的相對位置
t_values = np.linspace(0, 1, n_points)  # 0=蝦子頭部，1=蝦子尾部

# 在左蝦子的實際範圍內按相對位置採樣
left_x = left_x_min + t_values * (left_x_max - left_x_min)
left_y = 根據曲線方程計算

# 在右蝦子的實際範圍內按相同相對位置採樣
right_x = right_x_min + t_values * (right_x_max - right_x_min)
right_y = 根據曲線方程計算
```

**優點**：確保採樣的點在蝦子身體上的相對位置相同（如都是蝦子身體的1/3處）。

### 步驟4：視差計算
```python
disparities = left_x - right_x
```

### 步驟5：有效性檢查
檢查y座標差異，在校正良好的立體圖像對中，對應點的y座標應該相近：
```python
y_diff = np.abs(left_y - right_y)
valid_mask = y_diff < threshold  # 原本是5像素，現在動態調整
```

## 4. 當前實作的問題分析

### 問題1：圖像對可能未校正
如果左右圖像沒有經過立體校正，對應點的y座標可能差異很大。

### 問題2：時間不同步
左右圖像可能不是同一時刻拍攝，蝦子位置可能已經改變。

### 問題3：對應點匹配不準確
目前的對應點採樣方法可能無法準確找到蝦子身體上的對應部位。

## 5. 改進建議

### 建議1：改善對應點匹配
使用蝦子的形態學特徵（如頭部、身體中段、尾部）來建立更準確的對應關係。

### 建議2：放寬有效性約束
對於未校正的圖像對，應該放寬y座標差異的限制。

### 建議3：使用特徵點匹配
除了曲線採樣，還可以嘗試在蝦子上檢測特徵點（如關節、紋理）進行匹配。

## 6. 視差結果的解釋

### 正常的視差值範圍
- 近距離物體：10-100像素
- 中距離物體：5-50像素  
- 遠距離物體：1-10像素

### 異常情況
- 視差為負值且絕對值很大：可能是左右圖像搞反了
- 視差變化很大：物體可能不在同一深度平面上
- 有效點數為0：對應點匹配失敗

## 7. 實際應用考量

對於水產養殖中的蝦子：
1. 蝦子會游動，精確的點對點匹配很困難
2. 可以使用平均視差來估計蝦子的大致深度
3. 視差的變化可以反映蝦子身體的3D形狀
4. 多隻蝦子的視差分布可以分析牠們在水中的分布情況
